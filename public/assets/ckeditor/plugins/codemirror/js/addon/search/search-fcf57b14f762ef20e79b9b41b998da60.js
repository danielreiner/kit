(function(){function e(e){return"string"==typeof e?{token:function(t){if(t.match(e))return"searching";t.next(),t.skipTo(e.charAt(0))||t.skipToEnd()}}:{token:function(t){if(t.match(e))return"searching";for(;!t.eol()&&(t.next(),!t.match(e,!1)););}}}function t(){this.overlay=this.posFrom=this.posTo=this.query=null}function n(e,t,n){return e.getSearchCursor(t,n,"string"==typeof t&&t==t.toLowerCase())}function r(e,t,n,r){e.openDialog?e.openDialog(t,r):r(prompt(n,""))}function i(e,t,n,r){e.openConfirm?e.openConfirm(t,r):confirm(n)&&r[0]()}function s(e){var t=e.match(/^\/(.*)\/([a-z]*)$/);return t?RegExp(t[1],-1==t[2].indexOf("i")?"":"i"):e}function o(n,i){var o=n._searchState||(n._searchState=new t);if(o.query)return u(n,i);r(n,l,"Search for:",function(t){n.operation(function(){t&&!o.query&&(o.query=s(t),n.removeOverlay(o.overlay),o.overlay=e(t),n.addOverlay(o.overlay),o.posFrom=o.posTo=n.getCursor(),u(n,i))})})}function u(e,r){e.operation(function(){var i=e._searchState||(e._searchState=new t),s=n(e,i.query,r?i.posFrom:i.posTo);if(!s.find(r)&&(s=n(e,i.query,r?CodeMirror.Pos(e.lastLine()):CodeMirror.Pos(e.firstLine(),0)),!s.find(r)))return;e.setSelection(s.from(),s.to()),i.posFrom=s.from(),i.posTo=s.to()})}function a(e){e.operation(function(){var n=e._searchState||(e._searchState=new t);n.query&&(n.query=null,e.removeOverlay(n.overlay))})}function f(e,t){r(e,c,"Replace:",function(o){o&&(o=s(o),r(e,h,"Replace with:",function(r){if(t)e.operation(function(){for(var t=n(e,o);t.findNext();)if("string"!=typeof o){var i=e.getRange(t.from(),t.to()).match(o);t.replace(r.replace(/\$(\d)/,function(e,t){return i[t]}))}else t.replace(r)});else{a(e);var s=n(e,o,e.getCursor()),u=function(){var t=s.from(),r;if(!(r=s.findNext()))if(s=n(e,o),!(r=s.findNext())||t&&s.from().line==t.line&&s.from().ch==t.ch)return;e.setSelection(s.from(),s.to()),i(e,p,"Replace?",[function(){f(r)},u])},f=function(e){s.replace("string"==typeof o?r:r.replace(/\$(\d)/,function(t,n){return e[n]})),u()};u()}}))})}var l='Search: <input type="text" style="width: 10em"/> <span style="color: #888">(Use /re/ syntax for regexp search)</span>',c='Replace: <input type="text" style="width: 10em"/> <span style="color: #888">(Use /re/ syntax for regexp search)</span>',h='With: <input type="text" style="width: 10em"/>',p="Replace? <button>Yes</button> <button>No</button> <button>Stop</button>";CodeMirror.commands.find=function(e){a(e),o(e)},CodeMirror.commands.findNext=o,CodeMirror.commands.findPrev=function(e){o(e,!0)},CodeMirror.commands.clearSearch=a,CodeMirror.commands.replace=f,CodeMirror.commands.replaceAll=function(e){f(e,!0)}})();